# Copyright (C) 2025-2026  Henrique Almeida
# This file is part of h3nc4-compose.
#
# h3nc4-compose is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# h3nc4-compose is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with h3nc4-compose.  If not, see <https://www.gnu.org/licenses/>.

name: h3nc4-compose

networks:
  exposed:
    name: exposed
    driver: bridge
    internal: false
    driver_opts:
      com.docker.network.bridge.enable_icc: "false"

  external:
    name: external
    driver: bridge
    internal: false

  internal:
    name: internal
    driver: bridge
    internal: true

services:
  dns:
    container_name: dns
    image: coredns/coredns:1.14.1@sha256:82b57287b29beb757c740dbbe68f2d4723da94715b563fffad5c13438b71b14a
    restart: always
    command: -conf /config/Corefile
    read_only: true
    profiles:
      - production
    ports:
      - "0.0.0.0:53:53/udp"
      - "0.0.0.0:53:53/tcp"
    cap_drop:
      - NET_RAW
      - MKNOD
      - SYS_MODULE
    security_opt:
      - no-new-privileges:true
    volumes:
      - ./config/coredns/Corefile:/config/Corefile:ro
      - ./config/coredns/blocklist.hosts:/config/blocklist.hosts:ro
    networks:
      - internal
      - exposed

  maddy:
    image: foxcpp/maddy:0.8@sha256:eeb5813fc4d101ec5d8f7b08b7255fd76ced2a06884ea94450c8a9a22fd6a08d
    container_name: maddy
    restart: always
    environment:
      - MADDY_HOSTNAME=${MADDY_HOSTNAME}
      - MADDY_DOMAIN=${MADDY_DOMAIN}
      - SMTP_RELAY_HOST=${SMTP_RELAY_HOST}
      - SMTP_RELAY_USER=${SMTP_RELAY_USER}
      - SMTP_RELAY_PASSWORD=${SMTP_RELAY_PASSWORD}
    ports:
      - "[::]:25:25" # SMTP
      - "[::]:587:587" # Submission
      - "[::]:993:993" # IMAP
    volumes:
      - ./data/maddy:/data
      - ./config/maddy/maddy.conf:/data/maddy.conf
      - ./data/certbot/certs/:/etc/letsencrypt/
    networks:
      - internal
      - exposed

  tddns:
    container_name: tddns
    image: h3nc4/tddns@sha256:c96752264e4f533de5639cf66e9432bb64f7f2b5ba8af4f3b1a181fff7c8efdb
    restart: always
    profiles:
      - production
    network_mode: "host"
    environment:
      - CF_TOKEN=${CF_TOKEN}
      - DOMAIN=${DOMAIN}
      - RECORD_TYPE=${RECORD_TYPE}
    volumes:
      - ./data/tddns:/var/run
    cap_drop:
      - ALL

  cloudflared:
    container_name: cloudflared
    image: cloudflare/cloudflared@sha256:404528c1cd63c3eb882c257ae524919e4376115e6fe57befca8d603656a91a4c
    restart: always
    profiles:
      - production
    read_only: true
    command: tunnel --config /etc/cloudflared/config.yml run
    environment:
      - TUNNEL_TOKEN=${TUNNEL_TOKEN}
    volumes:
      - ./config/cloudflared/config.yml:/etc/cloudflared/config.yml:ro
    networks:
      - internal
      - external

  h3nc4:
    container_name: h3nc4
    domainname: h3nc4.com
    image: h3nc4/portfolio@sha256:b70f93009719392e98ce5aed15a609abfbcd82f82846d66b7359ed0d5545a534
    restart: always
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    networks:
      - internal

  wasudoku:
    container_name: wasudoku
    hostname: wasudoku
    domainname: h3nc4.com
    image: h3nc4/wasudoku@sha256:ed44201939c47bce1406dcbfe4a848cd9b758baff4413ab7df94ffa9759be787
    restart: always
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    networks:
      - internal

  cgit:
    container_name: cgit
    image: h3nc4/cgit-slim@sha256:ed4a97102fbe76f729905ee3cd2e1b58bef8667b3b895474c6ac6356d57604e9
    restart: always
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    volumes:
      - ./config/cgit/repos.list:/etc/cgit/repos.list:ro
      - ./data/cgit/git:/var/lib/git
      - ./data/cgit/ssh/id_ed25519:/run/.ssh/id_ed25519
      - ./data/cgit/ssh/id_ed25519.pub:/run/.ssh/id_ed25519.pub
    extra_hosts:
      - "github.com:4.228.31.150"
    networks:
      - internal
      - external

  tor:
    container_name: tor
    image: h3nc4/tor-slim@sha256:3b9a03059b058abd799e4db627192dea3410488b5f92a37a3a966b0bd1af309c
    restart: always
    profiles:
      - production
    read_only: true
    user: "65534:65534"
    ports:
      - "0.0.0.0:9050:9050/tcp"
    cap_drop:
      - ALL
      - MKNOD
    security_opt:
      - no-new-privileges:true
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./config/tor/torrc:/etc/tor/torrc:ro
      - ./data/tor:/var/lib/tor
    networks:
      - internal
      - external

  tor-reverse-proxy:
    container_name: tor-reverse-proxy
    image: h3nc4/nginx-slim@sha256:e8132c7455c017b90b6641c59991b0ead529f228ee2afdebefa139c7098707f8
    restart: always
    volumes:
      - ./config/tor/nginx.conf:/etc/nginx.conf:ro
    networks:
      - internal

  telegram-scout:
    container_name: telegram-scout
    image: h3nc4/telegram-scout@sha256:f93de2753c45bdb28cac83e374d50f1cfc38bd858eabe9a21c31cd81649aa77f
    restart: always
    profiles:
      - production
    environment:
      - TELEGRAM_API_ID=${TELEGRAM_API_ID}
      - TELEGRAM_API_HASH=${TELEGRAM_API_HASH}
      - TELEGRAM_PHONE=${TELEGRAM_PHONE}
      - TELEGRAM_PASSWORD=${TELEGRAM_PASSWORD}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      - TELEGRAM_SESSION=${TELEGRAM_SESSION}
    volumes:
      - ./config/telegram-scout/config.yaml:/config.yaml:ro
    networks:
      - external

  wireguard:
    container_name: wireguard
    image: codeberg.org/wg-easy/wg-easy:15@sha256:cf815209439101842f81d62bb25f7d66140e4cf8c100b4de5d0e84569d38732a
    network_mode: 'host'
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    devices:
      - /dev/net/tun:/dev/net/tun
    volumes:
      - ./data/wireguard:/etc/wireguard
      - /lib/modules:/lib/modules:ro
    environment:
      - INSECURE=true

  syshealthcheck:
    container_name: syshealthcheck
    image: busybox:musl@sha256:19b646668802469d968a05342a601e78da4322a414a7c09b1c9ee25165042138
    volumes:
      - ./test.sh:/test.sh:ro
    command: /test.sh
    environment:
      - CI=${CI:-false}
    healthcheck:
      test: [ "CMD", "test", "-f", "/healthy" ]
      interval: 1s
      timeout: 1s
      retries: 20
      start_period: 1s
    depends_on:
      - maddy
      - cgit
      - h3nc4
      - wasudoku
      - tor-reverse-proxy
    networks:
      - internal
