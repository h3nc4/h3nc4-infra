# Copyright (C) 2025-2026  Henrique Almeida
# This file is part of h3nc4-compose.
#
# h3nc4-compose is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# h3nc4-compose is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with h3nc4-compose.  If not, see <https://www.gnu.org/licenses/>.

name: h3nc4-compose

networks:
  exposed:
    name: exposed
    driver: bridge
    internal: false
    driver_opts:
      com.docker.network.bridge.enable_icc: "false"

  external:
    name: external
    driver: bridge
    internal: false

  internal:
    name: internal
    driver: bridge
    internal: true

services:
  maddy:
    image: foxcpp/maddy:0.8@sha256:eeb5813fc4d101ec5d8f7b08b7255fd76ced2a06884ea94450c8a9a22fd6a08d
    container_name: maddy
    restart: always
    environment:
      - MADDY_HOSTNAME=${MADDY_HOSTNAME}
      - MADDY_DOMAIN=${MADDY_DOMAIN}
      - SMTP_RELAY_HOST=${SMTP_RELAY_HOST}
      - SMTP_RELAY_USER=${SMTP_RELAY_USER}
      - SMTP_RELAY_PASSWORD=${SMTP_RELAY_PASSWORD}
    ports:
      - "[::]:25:25" # SMTP
      - "[::]:587:587" # Submission
      - "[::]:993:993" # IMAP
    volumes:
      - ./data/maddy:/data
      - ./config/maddy/maddy.conf:/data/maddy.conf
      - ./data/certbot/certs/:/etc/letsencrypt/
    networks:
      - internal
      - exposed

  tddns:
    container_name: tddns
    image: h3nc4/tddns@sha256:c4d9718951840e827c1300b24ea2d9aa69635f11385534218d7b753bf0da5e47
    restart: always
    profiles:
      - production
    network_mode: "host"
    environment:
      - CF_TOKEN=${CF_TOKEN}
      - DOMAIN=${DOMAIN}
      - RECORD_TYPE=${RECORD_TYPE}
    volumes:
      - ./data/tddns:/var/run
    cap_drop:
      - ALL

  cloudflared:
    container_name: cloudflared
    image: cloudflare/cloudflared@sha256:404528c1cd63c3eb882c257ae524919e4376115e6fe57befca8d603656a91a4c
    restart: always
    profiles:
      - production
    read_only: true
    command: tunnel --config /etc/cloudflared/config.yml run
    environment:
      - TUNNEL_TOKEN=${TUNNEL_TOKEN}
    volumes:
      - ./config/cloudflared/config.yml:/etc/cloudflared/config.yml:ro
    networks:
      - internal
      - external

  h3nc4:
    container_name: h3nc4
    domainname: h3nc4.com
    image: h3nc4/portfolio@sha256:ab8509b471b41414157c070993b6f8fc18bf21d28a6dff4422d62b25dfd2dd89
    restart: always
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    networks:
      - internal

  wasudoku:
    container_name: wasudoku
    hostname: wasudoku
    domainname: h3nc4.com
    image: h3nc4/wasudoku@sha256:5dcdf1b23ac50a43893e9ccc52730d4cb360368c5c1bf9a253392c9a8288f12a
    restart: always
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    networks:
      - internal

  cgit:
    container_name: cgit
    image: h3nc4/cgit-slim@sha256:ac89cb7750ebc9334fb3457de66925f70c2d73141bfdd5fb3f0eff999f030794
    restart: always
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    volumes:
      - ./config/cgit/repos.list:/etc/cgit/repos.list:ro
      - ./data/cgit/git:/var/lib/git
      - ./data/cgit/ssh/id_ed25519:/run/.ssh/id_ed25519
      - ./data/cgit/ssh/id_ed25519.pub:/run/.ssh/id_ed25519.pub
    extra_hosts:
      - "github.com:4.228.31.150"
    networks:
      - internal
      - external

  tor:
    container_name: tor
    image: h3nc4/tor-slim@sha256:3f482fee82bd05431008f6f9ff7613b84657721dda584dc81835461c92f4b0c0
    restart: always
    profiles:
      - production
    read_only: true
    user: "65534:65534"
    cap_drop:
      - ALL
      - MKNOD
    security_opt:
      - no-new-privileges:true
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./config/tor/torrc:/etc/tor/torrc:ro
      - ./data/tor:/var/lib/tor
    networks:
      - internal
      - external

  tor-reverse-proxy:
    container_name: tor-reverse-proxy
    image: h3nc4/nginx-slim@sha256:3587544cb6a188432670d631c381fbed89da5888854f74a364f44f391215f8c9
    restart: always
    volumes:
      - ./config/tor/nginx.conf:/etc/nginx.conf:ro
    networks:
      - internal

  telegram-scout:
    container_name: telegram-scout
    image: h3nc4/telegram-scout@sha256:94591158205d4063598d30651cecd9d19aef228e079189b44ad2b942753204b4
    restart: always
    profiles:
      - production
    environment:
      - TELEGRAM_API_ID=${TELEGRAM_API_ID}
      - TELEGRAM_API_HASH=${TELEGRAM_API_HASH}
      - TELEGRAM_PHONE=${TELEGRAM_PHONE}
      - TELEGRAM_PASSWORD=${TELEGRAM_PASSWORD}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      - TELEGRAM_SESSION=${TELEGRAM_SESSION}
    volumes:
      - ./config/telegram-scout/config.yaml:/config.yaml:ro
    networks:
      - external

  syshealthcheck:
    container_name: syshealthcheck
    image: busybox:musl@sha256:19b646668802469d968a05342a601e78da4322a414a7c09b1c9ee25165042138
    volumes:
      - ./test.sh:/test.sh:ro
    command: /test.sh
    environment:
      - CI=${CI:-false}
    healthcheck:
      test: [ "CMD", "test", "-f", "/healthy" ]
      interval: 1s
      timeout: 1s
      retries: 20
      start_period: 1s
    depends_on:
      - maddy
      - cgit
      - h3nc4
      - wasudoku
      - tor-reverse-proxy
    networks:
      - internal
